<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å–œè¿å…ƒæ—¦ | è·¨å¹´å€’è®¡æ—¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- è§†è§‰æ ·å¼ --- */
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        .font-festive { font-family: "Kaiti SC", "STKaiti", "KaiTi", serif; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .chart-container { position: relative; width: 100%; max-width: 450px; margin: 0 auto; height: 300px; max-height: 350px; }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(220, 38, 38, 0.1); border-left-color: #dc2626;
            border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Lantern & Glow Effects */
        .lantern-container { position: absolute; top: -10px; z-index: 10; display: flex; justify-content: space-between; width: 100%; pointer-events: none; overflow: hidden; padding: 0 20px; }
        .lantern { width: 60px; height: 50px; background: #dc2626; border-radius: 15px; position: relative; animation: swing 4s infinite ease-in-out; box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4); }
        .lantern::before, .lantern::after { content: ''; position: absolute; left: 50%; transform: translateX(-50%); width: 30px; height: 6px; background: #fcd34d; border-radius: 2px; }
        .lantern::before { top: -4px; } .lantern::after { bottom: -4px; }
        .lantern-tassel { width: 4px; height: 20px; background: #ef4444; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); }
        .lantern-string { width: 2px; height: 30px; background: #b45309; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); }
        @keyframes swing { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        .glow-effect { animation: glow 3s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px rgba(220, 38, 38, 0.2); } 50% { box-shadow: 0 0 25px rgba(220, 38, 38, 0.6); } }
        
        /* Confetti Canvas */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
    </style>
</head>
<body class="bg-red-50 text-stone-800 font-sans min-h-screen flex flex-col overflow-x-hidden relative">

    <canvas id="confetti-canvas"></canvas>

    <!-- UI Decor -->
    <div class="lantern-container max-w-5xl mx-auto left-0 right-0">
        <div style="position:relative; left: 5%;"> <div class="lantern-string"></div> <div class="lantern"><div class="lantern-tassel"></div></div> </div>
        <div style="position:relative; right: 5%; animation-delay: 1s;"> <div class="lantern-string"></div> <div class="lantern"><div class="lantern-tassel"></div></div> </div>
    </div>

    <!-- Header -->
    <header class="w-full bg-gradient-to-b from-red-700 to-red-600 shadow-lg border-b-4 border-amber-400 py-10 relative overflow-hidden">
        <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fbbf24 1px, transparent 1px); background-size: 20px 20px;"></div>
        <div class="container mx-auto px-4 text-center relative z-10 cursor-pointer" onclick="window.fireConfetti()">
            <div class="inline-block bg-red-800 text-amber-300 text-xs px-3 py-1 rounded-full mb-3 border border-amber-500 uppercase tracking-wider">
                Full Stack: Worker + KV
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-wide font-festive drop-shadow-md">
                å–œè¿ <span class="text-amber-300 text-5xl md:text-6xl">2026</span> å…ƒæ—¦
            </h1>
            <p class="mt-3 text-red-100 text-sm md:text-base font-light">
                ä¸‡è±¡æ›´æ–° Â· ç ¥ç ºå‰è¡Œ Â· <span class="border-b border-red-400 pb-0.5">ç‚¹å‡»æ­¤å¤„ç‡ƒæ”¾çƒŸèŠ±</span> âœ¨
            </p>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 md:py-12 space-y-12 max-w-5xl relative z-20">
        <!-- Countdown View -->
        <section class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border-2 border-red-100 glow-effect">
            <div class="text-center mb-10">
                <h2 class="text-xl font-bold text-red-700 font-festive text-2xl mb-2">è·ç¦» 2026 å¹´ 1 æœˆ 1 æ—¥ è¿˜æœ‰</h2>
                <div class="w-24 h-1 bg-gradient-to-r from-transparent via-red-400 to-transparent mx-auto"></div>
            </div>
            <div id="countdown-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 max-w-4xl mx-auto">
                <div class="bg-red-600 rounded-2xl p-4 flex flex-col items-center justify-center shadow-lg border-b-8 border-red-800 transform hover:-translate-y-1 transition-transform duration-300"><span id="days" class="text-4xl md:text-6xl font-bold text-amber-100 tabular-nums">000</span><span class="text-xs md:text-sm font-bold text-red-200 uppercase mt-2 tracking-widest">å¤© (Days)</span></div>
                <div class="bg-red-600 rounded-2xl p-4 flex flex-col items-center justify-center shadow-lg border-b-8 border-red-800 transform hover:-translate-y-1 transition-transform duration-300"><span id="hours" class="text-4xl md:text-6xl font-bold text-amber-100 tabular-nums">00</span><span class="text-xs md:text-sm font-bold text-red-200 uppercase mt-2 tracking-widest">æ—¶ (Hours)</span></div>
                <div class="bg-red-600 rounded-2xl p-4 flex flex-col items-center justify-center shadow-lg border-b-8 border-red-800 transform hover:-translate-y-1 transition-transform duration-300"><span id="minutes" class="text-4xl md:text-6xl font-bold text-amber-100 tabular-nums">00</span><span class="text-xs md:text-sm font-bold text-red-200 uppercase mt-2 tracking-widest">åˆ† (Mins)</span></div>
                <div class="bg-amber-400 rounded-2xl p-4 flex flex-col items-center justify-center shadow-lg border-b-8 border-amber-600 transform hover:-translate-y-1 transition-transform duration-300"><span id="seconds" class="text-4xl md:text-6xl font-bold text-red-700 tabular-nums">00</span><span class="text-xs md:text-sm font-bold text-red-800 uppercase mt-2 tracking-widest">ç§’ (Secs)</span></div>
            </div>
            <div id="countdown-message" class="hidden text-center mt-8 p-6 bg-red-100 text-red-800 rounded-xl font-bold text-2xl border-2 border-red-300">ğŸ‰ æ–°å¹´å¿«ä¹ï¼Happy New Year 2026! ğŸŠ</div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Analytics View -->
            <section class="bg-white rounded-3xl shadow-lg p-6 border border-red-50 flex flex-col">
                <div class="mb-4 pl-2 border-l-4 border-red-500">
                    <h3 class="text-lg font-bold text-stone-800">2025 æ—¶å…‰å°è®°</h3>
                    <p class="text-sm text-stone-500 mt-1">æ•°æ®å¯è§†åŒ–ï¼šå·²é€æ—¶å…‰ vs æœªæ¥æœŸè®¸</p>
                </div>
                <div class="flex-grow flex items-center justify-center w-full py-4 relative">
                    <div class="chart-container">
                        <canvas id="yearProgressChart"></canvas>
                    </div>
                </div>
                <div class="mt-4 text-center bg-red-50 rounded-lg p-3">
                    <p id="progress-text" class="text-stone-700 font-medium">åŠ è½½ä¸­...</p>
                </div>
            </section>

            <!-- Wishes View -->
            <section class="bg-white rounded-3xl shadow-lg p-6 border border-red-50 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-red-100 rounded-full opacity-50 z-0"></div>
                <div class="mb-4 pl-2 border-l-4 border-amber-500 relative z-10 flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-stone-800">2026 äº‘ç«¯æ„¿æœ›å•</h3>
                        <p class="text-sm text-stone-500 mt-1">å†™ä¸‹ä½ çš„æ–°å¹´æ„¿æœ›ï¼Œè®©å®ƒä»¬åœ¨ 2026 å¼€èŠ±ç»“æœ</p>
                    </div>
                    <div id="connection-status" class="flex items-center text-xs text-stone-400 bg-stone-100 px-2 py-1 rounded-md">
                        <span class="spinner mr-1"></span> è¿æ¥åç«¯...
                    </div>
                </div>
                <div class="flex-grow bg-stone-50 rounded-xl p-4 mb-4 overflow-y-auto max-h-[300px] border border-stone-200 relative z-10" id="wishes-container">
                    <!-- Wish items injected by View -->
                </div>
                <div class="flex gap-2 relative z-10">
                    <input type="text" id="wish-input" placeholder="æ­£åœ¨è¿æ¥ API..." disabled class="flex-grow px-4 py-3 border border-red-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-amber-400 bg-white shadow-sm disabled:bg-stone-100 disabled:cursor-not-allowed">
                    <button id="add-wish-btn" disabled class="px-6 py-3 bg-stone-400 text-white rounded-xl font-bold shadow-md disabled:cursor-not-allowed transition-all">è®¸æ„¿</button>
                </div>
            </section>
        </div>
    </main>

    <footer class="w-full bg-stone-100 border-t border-red-100 py-8 mt-8 text-center text-sm text-stone-500">
        <p>&copy; 2025-2026 è·¨å¹´å€’è®¡æ—¶ | æ¶æ„ï¼šFrontend + Cloudflare Worker</p>
        <p class="text-xs text-stone-400 mt-1"><a href="https://beian.miit.gov.cn/" target="_blank">çš–ICPå¤‡2025092209å·</a></p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ========================================================
        // 1. é…ç½®åŒºåŸŸ (CONFIGURATION)
        // ========================================================
        
        // ã€é‡è¦ã€‘ï¼šéƒ¨ç½² Worker åï¼Œè¯·å°†è¿™é‡Œçš„ false æ”¹ä¸º falseï¼Œå¹¶å¡«å…¥ URL
        // ç¤ºä¾‹: "https://my-wish-worker.username.workers.dev/api/wishes"
        const WORKER_API_URL = "https://2026.niuma.edu.kg/api/wishes"; 
        
        // é¢„è§ˆæ¨¡å¼å¼€å…³ï¼šä¸ºä¿è¯æ‚¨ç°åœ¨èƒ½çœ‹åˆ°æ•ˆæœï¼Œé»˜è®¤å¼€å¯æ¨¡æ‹Ÿæ•°æ®ï¼ˆå› ä¸ºè¿˜æ²¡éƒ¨ç½² Workerï¼‰
        // å¦‚æœæ‚¨å¡«å…¥äº†ä¸Šé¢çš„ URLï¼Œè¯·å°†ä¸‹é¢è®¾ä¸º false
        const IS_MOCK_MODE = false; 

        // ========================================================
        // 2. API æœåŠ¡å±‚ (SERVICE LAYER)
        // è´Ÿè´£ä¸ Cloudflare Worker é€šä¿¡
        // ========================================================
        class WishService {
            constructor(apiUrl, isMock) {
                this.apiUrl = apiUrl;
                this.isMock = isMock;
                // Mock data store
                if(isMock) {
                    console.log("âš ï¸ è¿è¡Œåœ¨æ¨¡æ‹Ÿæ¨¡å¼ (Mock Mode). æ•°æ®å­˜å‚¨åœ¨ LocalStorage.");
                    this.mockStore = JSON.parse(localStorage.getItem('mock_wishes') || '[]');
                }
            }

            async getAll() {
                if (this.isMock) {
                    await new Promise(r => setTimeout(r, 800)); // Simulate network lag
                    return this.mockStore;
                }
                
                try {
                    const res = await fetch(this.apiUrl);
                    if (!res.ok) throw new Error("API Error");
                    return await res.json();
                } catch (e) {
                    console.error("Fetch failed", e);
                    throw e;
                }
            }

            async add(text) {
                if (this.isMock) {
                    await new Promise(r => setTimeout(r, 500));
                    const newWish = { id: Date.now().toString(), text, timestamp: Date.now() };
                    this.mockStore.unshift(newWish);
                    localStorage.setItem('mock_wishes', JSON.stringify(this.mockStore));
                    return newWish;
                }

                try {
                    const res = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text })
                    });
                    if (!res.ok) throw new Error("Add failed");
                    return await res.json();
                } catch (e) {
                    console.error("Add failed", e);
                    throw e;
                }
            }

            async delete(id) {
                if (this.isMock) {
                    this.mockStore = this.mockStore.filter(w => w.id !== id);
                    localStorage.setItem('mock_wishes', JSON.stringify(this.mockStore));
                    return true;
                }

                try {
                    const res = await fetch(this.apiUrl, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    return res.ok;
                } catch (e) {
                    console.error("Delete failed", e);
                    throw e;
                }
            }
        }

        // ========================================================
        // 3. é¡µé¢é€»è¾‘ (CONTROLLER)
        // ========================================================
        document.addEventListener('DOMContentLoaded', async () => {
            const api = new WishService(WORKER_API_URL, IS_MOCK_MODE);
            
            // UI References
            const els = {
                status: document.getElementById('connection-status'),
                input: document.getElementById('wish-input'),
                btn: document.getElementById('add-wish-btn'),
                list: document.getElementById('wishes-container'),
                days: document.getElementById('days'),
                hours: document.getElementById('hours'),
                minutes: document.getElementById('minutes'),
                seconds: document.getElementById('seconds'),
            };

            // --- Countdown Logic ---
            const target = new Date('January 1, 2026 00:00:00').getTime();
            setInterval(() => {
                const now = Date.now();
                const dist = target - now;
                if (dist < 0) return;
                els.days.innerText = Math.floor(dist / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
                els.hours.innerText = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                els.minutes.innerText = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                els.seconds.innerText = Math.floor((dist % (1000 * 60)) / 1000).toString().padStart(2, '0');
            }, 1000);

            // --- Chart Logic ---
            const start = new Date('January 1, 2025 00:00:00').getTime();
            const end = new Date('December 31, 2025 23:59:59').getTime();
            const now = Date.now();
            const pct = Math.min(100, Math.max(0, ((now - start) / (end - start)) * 100));
            document.getElementById('progress-text').innerHTML = `2025 å¹´å·²è¿‡å» <span class="font-bold text-red-600 text-lg">${pct.toFixed(2)}%</span>`;
            
            new Chart(document.getElementById('yearProgressChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['å·²è¿‡å»', 'å‰©ä½™'],
                    datasets: [{
                        data: [pct, 100 - pct],
                        backgroundColor: ['#ef4444', '#fbbf24'],
                        borderWidth: 2, borderColor: '#ffffff', hoverOffset: 6
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } } }
            });

            // --- Wish Logic (Backend Integration) ---
            const renderList = (wishes) => {
                els.list.innerHTML = '';
                if (wishes.length === 0) {
                    els.list.innerHTML = '<p class="text-stone-400 text-center italic mt-10">ğŸ® æš‚æ— æ„¿æœ›ï¼Œå¿«æ¥è®¸æ„¿å§ï¼</p>';
                    return;
                }
                const ul = document.createElement('ul');
                ul.className = "space-y-3";
                wishes.forEach(w => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border-l-4 border-red-400 animate-[fadeIn_0.3s_ease-out]';
                    li.innerHTML = `
                        <div class="flex items-center"><span class="text-amber-500 mr-2">âœ¨</span><span class="text-stone-700 font-medium break-all">${w.text}</span></div>
                        <button class="delete-btn text-stone-300 hover:text-red-500 px-2" data-id="${w.id}">&times;</button>
                    `;
                    ul.appendChild(li);
                });
                els.list.appendChild(ul);

                // Bind delete
                document.querySelectorAll('.delete-btn').forEach(b => {
                    b.addEventListener('click', async (e) => {
                        const id = e.target.getAttribute('data-id');
                        e.target.innerText = "...";
                        await api.delete(id);
                        loadWishes();
                    });
                });
            };

            const loadWishes = async () => {
                try {
                    const data = await api.getAll();
                    renderList(data);
                    // Update UI State
                    els.status.innerHTML = `<span class="text-green-600 font-bold">â— ${IS_MOCK_MODE ? 'æ¨¡æ‹Ÿæ¨¡å¼' : 'Worker å·²è¿æ¥'}</span>`;
                    els.input.disabled = false;
                    els.input.placeholder = "è®¸ä¸‹æ–°å¹´æ„¿æœ›...";
                    els.btn.disabled = false;
                    els.btn.className = "px-6 py-3 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl hover:from-red-700 hover:to-red-600 transition-all font-bold shadow-md hover:shadow-lg transform active:scale-95";
                } catch (e) {
                    els.status.innerHTML = `<span class="text-red-500">è¿æ¥å¤±è´¥</span>`;
                    console.error(e);
                }
            };

            els.btn.addEventListener('click', async () => {
                const val = els.input.value.trim();
                if(!val) return;
                els.input.value = '';
                els.input.disabled = true; // prevent double submit
                await api.add(val);
                window.fireConfetti();
                els.input.disabled = false;
                els.input.focus();
                loadWishes();
            });

            // Initial Load
            loadWishes();

            // --- Visual FX (Confetti) ---
            const cvs = document.getElementById('confetti-canvas');
            const ctx = cvs.getContext('2d');
            let parts = [];
            const resize = () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            window.fireConfetti = () => {
                for(let i=0; i<60; i++) parts.push({
                    x: Math.random()*cvs.width, y: Math.random()*cvs.height-cvs.height,
                    c: ['#dc2626','#fbbf24','#f59e0b'][Math.floor(Math.random()*3)],
                    s: Math.random()*8+4, dy: Math.random()*3+2, dx: Math.random()*2-1, r: Math.random()*360
                });
            };
            const loop = () => {
                ctx.clearRect(0,0,cvs.width,cvs.height);
                parts.forEach((p,i) => {
                    p.y+=p.dy; p.x+=p.dx; p.r+=5;
                    ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r*Math.PI/180);
                    ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
                    if(p.y>cvs.height) parts.splice(i,1);
                });
                requestAnimationFrame(loop);
            };
            loop();
            setTimeout(window.fireConfetti, 500);
        });
    </script>
</body>
</html>